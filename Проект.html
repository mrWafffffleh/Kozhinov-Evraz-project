<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="Проект.css">
</head>
<body id="body">
    <div id="logo">
        <img src="Logo.png" alt="" id="logoimg">
    </div>
    <div class="divform">
            <h2>Сканер дефектов рельсы</h2>
            <div class="inputs">
                <label for="length">Длина рельсы(см):</label>
                <input type="number" id="length" placeholder="Например: 100">
            </div>
            <div class="inputs">
                <label for="defects">Координаты дефектов:</label>
                <input type="text" id="defects" placeholder="Например: 5, 15, 20">
            </div>
            <button onclick="scanner()">Сканировать</button>

    </div>
    <div class="invise" id="rail">
        <div class="scan" id="scanner"></div>
    </div>
    <ul id="list">

    </ul>
</body>
<script>

    let defects = document.getElementById("defects")
    let def = []
    let foundDefects = new Set()
    let stp = new Set()
    function scanner() {
        def = []
        stp = new Set()
        foundDefects = new Set()
        let lengthRail = document.getElementById("length")
        if (lengthRail.value == "") {
            alert("Введите длину рельсы")
            return;
        } else if (defects.value == "") {
            alert("Введите координаты дефектов")
            return;
        }
        def = defects.value.split(",").map(Number).filter(n => !isNaN(n))
        console.log(def)
        let flag = true
        def.forEach((item) => {
            if (item > +lengthRail.value) {
                flag = false
            }
        })
        if (flag == false) {
            alert('Некорректные данные')
            lengthRail.value = ''
            defects.value = ''
            return
        }
        let body = document.getElementById('body')
        let rail = document.getElementById('rail')
        rail.classList.remove('invise')
        rail.classList.add('rail-class')
        if(lengthRail.value <= 65){
            rail.style.width = `${lengthRail.value * 20}px`
            rail.innerHTML = ''
            def.forEach(defs => {
                let defect = document.createElement('div')
                defect.className = 'defect'
                defect.style.left = `${defs * 20}px`
                rail.appendChild(defect)
            })
        }
        else if(lengthRail.value > 65){
            rail.style.width = `${lengthRail.value * 10}px`
            rail.innerHTML = ''
            def.forEach(defs => {
                let defect = document.createElement('div')
                defect.className = 'defect'
                defect.style.left = `${defs * 10}px`
                rail.appendChild(defect)
            })
        }
        let checkpoints = []
        let LaserCord = 0
        let Steps = 0
        stp.add(LaserCord)
        // Steps +=1
        let right = Infinity
        for(const coord of def){
            if(coord > LaserCord && coord < right){
                right = coord
            }
        }
        if(def.includes(LaserCord)){
            foundDefects.add(LaserCord)
        }
        console.log(right)
        if(right !== Infinity){
            let distance = right - LaserCord
            console.log("distance right", distance)
            if(distance >= 1 && distance <= 5){
                checkpoints.push(LaserCord + 3)
            }
        }
        console.log(LaserCord <= +lengthRail.value, LaserCord, +lengthRail.value)
        while(LaserCord < +lengthRail.value){
            console.log('LaserCord', LaserCord)
            if(lengthRail.value - LaserCord >= 10){
                LaserCord +=10
                stp.add(LaserCord)
                // Steps +=1
                let left = -Infinity
                let right = Infinity
                for(const coord of def){
                    if(coord < LaserCord && coord > left) {
                        left = coord
                    }
                    if(coord > LaserCord && coord < right){
                        right = coord
                    }
                }
                if(def.includes(LaserCord)){
                    foundDefects.add(LaserCord)
                    console.log(1, LaserCord)
                }
                console.log(left)
                console.log(right)
                if(left !== -Infinity){
                    let distance = LaserCord - left
                    console.log("distance left", distance)
                    if(distance >= 1 && distance < 5){
                        checkpoints.push(LaserCord - 3)
                    }
                }
                if(right !== Infinity){
                    let distance = right - LaserCord
                    console.log("distance right", distance)
                    if(distance >= 1 && distance <= 5){
                        checkpoints.push(LaserCord + 3)
                    }
                }
            }
            else{
                LaserCord = +lengthRail.value
                stp.add(LaserCord)
                let left = -Infinity
                let right = Infinity
                for(const coord of def){
                    if(coord < LaserCord && coord > left) {
                        left = coord
                    }
                    if(coord > LaserCord && coord < right){
                        right = coord
                    }
                }
                if(def.includes(LaserCord)){
                    foundDefects.add(LaserCord)
                    console.log(2, LaserCord)
                }
                if(left !== -Infinity){
                    let distance = LaserCord - left
                    if(distance >= 1 && distance <= 5){
                        checkpoints.push(LaserCord - 3)
                    }
                }
            }
        }
        console.log("checkpoints", checkpoints)
        check(checkpoints, LaserCord, Steps)
    }
    function check(checkpoints, LaserCord, Steps){
        let remainingDefects = new Set()
        for(let i = 0; i < checkpoints.length; i++){
            LaserCord = checkpoints[i]
            stp.add(LaserCord)
            let left = -Infinity
            let right = Infinity
            for(const coord of def){
                if(coord < LaserCord && coord > left) {
                    left = coord
                }
                if(coord > LaserCord && coord < right){
                    right = coord
                }
            }
            console.log('right', right)
            console.log('left', left)
            if(def.includes(LaserCord)){
                foundDefects.add(LaserCord)
                console.log(3, LaserCord)
                let left = -Infinity
                let right = Infinity
                for(const coord of def){
                    if(coord < LaserCord && coord > left) {
                        left = coord
                    }
                    if(coord > LaserCord && coord < right){
                        right = coord
                    }
                }
                console.log('right', right)
                console.log('left', left)
                if(LaserCord - left <= 2){
                    LaserCord -= 1
                    stp.add(LaserCord)
                    if(left == LaserCord) {
                        foundDefects.add(LaserCord)
                        console.log(4, LaserCord)
                        let left = -Infinity
                        for (const coord of def) {
                            if (coord < LaserCord && coord > left) {
                                left = coord
                            }
                        }
                        if(LaserCord - left == 1){
                            foundDefects.add(LaserCord - 1)
                            console.log(5, LaserCord - 1)
                            remainingDefects.add((LaserCord - 1))
                        }
                    }
                    else{
                        foundDefects.add(LaserCord - 1)
                    }
                }
                LaserCord = checkpoints[i]
                // Steps +=1
                stp.add(LaserCord)
                if(right - LaserCord <= 2){
                    LaserCord = checkpoints[i] + 1
                    // Steps +=1
                    console.log(".",LaserCord)
                    if(right == LaserCord){
                        foundDefects.add(LaserCord)
                        let right = Infinity
                        for(const coord of def){
                            if(coord > LaserCord && coord < right){
                                right = coord
                            }
                        }
                        if(right - LaserCord == 1){
                            foundDefects.add(LaserCord+1)
                            console.log(6, LaserCord +1)
                            remainingDefects.add(LaserCord + 1)
                        }
                    }
                    else{
                        foundDefects.add(LaserCord+1)
                    }
                }
                console.log(foundDefects)
            }
            if(LaserCord - left == 1 || LaserCord - left == 2){
                console.log('right', right)
                console.log('left', left)
                LaserCord = checkpoints[i] - 1
                stp.add(LaserCord)
                if(left == LaserCord){
                    foundDefects.add(LaserCord)
                    console.log(7, LaserCord)
                }
                else{
                    foundDefects.add(LaserCord - 1)
                    console.log(8, LaserCord -1)
                    remainingDefects.add(LaserCord - 1)
                }
            }
            if(right - checkpoints[i] == 1 || right - checkpoints[i] == 2){
                console.log('right', right)
                console.log('left', left)
                LaserCord = checkpoints[i] +1
                stp.add(LaserCord)
                if(right == LaserCord){
                    foundDefects.add(LaserCord)
                    console.log(9, LaserCord)

                }
                else{
                    foundDefects.add(LaserCord + 1)
                    console.log(10, LaserCord+1)
                    remainingDefects.add(LaserCord + 1)
                }
            }
        }
        let foundDefectsArray = [ ...foundDefects ].sort((a, b) => a - b)
        console.log(foundDefectsArray)
        console.log(remainingDefects)
        write(stp, remainingDefects)
    }
    function write(stp, remainingDefects) {
        let list = document.getElementById('list');
        list.innerHTML = '';
        let sttp = Array.from(stp)
        let remainingDef = Array.from(remainingDefects)
        let ArrayfoundDef = Array.from(foundDefects).sort((a, b) => a - b)
        let mass = []
        for (let i = 0; i < sttp.length; i++) {
            let li = document.createElement('li');
            let currentPos = sttp[i];
            let posInfo = document.createElement('span');
            posInfo.textContent = `Шаг ${i+1}: Координата ${currentPos}. `;
            li.appendChild(posInfo);
            let defectInfo = document.createElement('span');
            let foundDefect = false;
            let defectPos = null;
            let detectionMethod = '';
            console.log('remainingDef', remainingDef)
            remainingDef.forEach((item) => {
                console.log('item', currentPos, item)
                if(currentPos !== 0){
                    if (Math.abs(currentPos - item) === 1) {
                        if(mass.includes(item) === false)
                            detectionMethod = `Дефект найден на координате ${item} по остаточному методу`
                        mass.push(item)
                    }
                }
            })
            if (def.includes(currentPos)) {
                defectPos = currentPos;
                foundDefect = true;
                defectInfo.innerHTML = `<strong>Найден дефект на ${defectPos}</strong><p style="color: red;">${detectionMethod}</p>`;
                defectInfo.style.color = 'red';
            }
            else {
                defectInfo.innerHTML = `<strong>Дефекты не обнаружены</strong><p style="color: red;">${detectionMethod}</p>`;
            }
            li.appendChild(defectInfo);
            let indicators = document.createElement('div');
            indicators.style.display = 'flex';
            indicators.style.gap = '10px';
            indicators.style.margin = '5px 0';
            let leftIndicator = createDefectIndicator(currentPos, 'left');
            indicators.appendChild(leftIndicator);
            let rightIndicator = createDefectIndicator(currentPos, 'right');
            indicators.appendChild(rightIndicator);
            li.appendChild(indicators);
            list.appendChild(li);
        }
        let stepsInfo = document.createElement('div');
        stepsInfo.textContent = `Всего выполнено шагов: ${stp.size}`;
        stepsInfo.style.marginTop = '20px';
        stepsInfo.style.fontWeight = 'bold';
        let defectsInform = document.createElement('div')
        defectsInform.textContent = `Найдены дефекты на координатах ${ArrayfoundDef.toString()}`
        defectsInform.style.marginTop = '20px'
        defectsInform.style.fontWeight = 'bold';
        list.appendChild(stepsInfo);
        list.appendChild(defectsInform);
    }
    function createDefectIndicator(position, direction) {
        let indicator = document.createElement('div');
        indicator.style.width = '20px';
        indicator.style.height = '20px';
        indicator.style.borderRadius = '50%';
        let nearestDefect = null;
        let minDistance = Infinity;
        for (const coord of def) {
            let distance = direction === 'left' ? position - coord : coord - position;
            if (distance > 0 && distance < minDistance) {
                minDistance = distance;
                nearestDefect = coord;
            }
        }
        if (nearestDefect !== null) {
            if (minDistance <= 5) {
                indicator.style.backgroundColor = 'red';
                indicator.title = `Дефект на ${nearestDefect} (расстояние ${minDistance})`;
            } else if (minDistance <= 10) {
                indicator.style.backgroundColor = 'yellow';
                indicator.title = `Дефект на ${nearestDefect}(расстояние ${minDistance})`;
            } else {
                indicator.style.backgroundColor = 'green';
                indicator.title = 'Дефектов в зоне нет';
            }
        } else {
            indicator.style.backgroundColor = 'green';
            indicator.title = 'Дефектов в зоне нет';
        }
        return indicator;
    }
</script>
</html>